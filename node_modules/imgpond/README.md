# imgpond

图片上传一站式解决方案

<br>

## 特性

- 支持数据双向绑定 `v-model`
- 支持上传前裁剪图片，可固定裁剪比例 / 比例范围
- 支持无级角度旋转
- 输出品质可调节
- 支持限定图片体积上限、下限
- 支持限定图片数量上限、下限
- 灵活的数据类型：支持 `string`、`JSON string`、`object`、`string[]`、`object[]`
- 支持拖拉拽排序
- 支持多选
- 支持轮播预览（上传完成后、处于禁用状态时）
- 适配 [element-ui](https://github.com/ElemeFE/element) （禁用状态默认跟随 `el-form`）
- 全局或局部注册，参数支持全局或局部配置（[vue-global-config](https://github.com/cloydlau/vue-global-config) 提供技术支持）

<br>

## 安装

### 外置依赖

- `element-ui`
- `pic-viewer`

![NPM](https://nodei.co/npm/imgpond.png)

### 全局注册

```ts
import 'pic-viewer/dist/style.css'
import PicViewer from 'pic-viewer'
Vue.use(PicViewer)

import 'imgpond/dist/style.css'
import Imgpond from 'imgpond'
Vue.use(Imgpond, {
  // 全局配置
})
```

### 局部注册

```vue
<template>
  <Imgpond v-model="value" v-bind="{/* 局部配置 */}"/>
</template>

<script>
import 'pic-viewer/dist/style.css'
import PicViewer from 'pic-viewer'
import 'imgpond/dist/style.css'
import Imgpond from 'imgpond'

export default {
  components: { PicViewer, Imgpond },
}
</script>
```

### CDN

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <link rel="stylesheet" href="https://unpkg.com/pic-viewer@0.5/dist/style.css">
  <link rel="stylesheet" href="https://unpkg.com/imgpond@0.6/dist/style.css">
</head>

<body>
  <div id="app">
    <Imgpond v-model="data"></Imgpond>
    <p v-text="data"></p>
  </div>
  <script src="https://unpkg.com/vue@2"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script src="https://unpkg.com/pic-viewer@0.5/dist/pic-viewer.umd.js"></script>
  <script src="https://unpkg.com/imgpond@0.6/dist/imgpond.umd.js"></script>
  <script>
    Vue.use(window['pic-viewer'].default)
    Vue.use(window['imgpond'].default)
    new Vue({
      data() {
        return {
          data: undefined,
        }
      },
    }).$mount('#app')
  </script>
</body>

</html>
```

<br>

## 参数

| 参数名               | 说明                                                                                              | 类型                               | 合法值                                                                              | 默认值              |
| -------------------- | ------------------------------------------------------------------------------------------------- | ---------------------------------- | ----------------------------------------------------------------------------------- | ------------------- |
| v-model / value      | 绑定值                                                                                            | string, string[], object, object[] |                                                                                     |                     |
| valueType            | 数据类型                                                                                          | string                             | `'string'`, `'array'`                                                               | `'auto'`            |
| srcAt                | 图片 src 所在的键（数据格式为对象时有效）                                                         | string                             |                                                                                     |                     |
| upload               | 调用接口上传图片                                                                                  | Function                           | axios, axios 实例等                                                                 |                     |
| disabled             | 禁用状态                                                                                          | boolean                            |                                                                                     | `false`             |
| aspectRatio          | 固定裁剪比例                                                                                      | string, string[]                   |                                                                                     |                     |
| aspectRatioDeviation | 固定裁剪比例的误差范围（默认情况下，小于 ± 10% 的比例差异不会被裁剪）                             | number                             |                                                                                     | `0.1`               |
| size                 | 图片大小限制（单位 MB）                                                                           | number, number[]                   |                                                                                     | `10`                |
| count                | 数量限制                                                                                          | number, number[]                   |                                                                                     | `50`                |
| accept               | 允许的[图片文件类型](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#attr-accept) | string                             | [MIME type](http://svn.apache.org/repos/asf/httpd/httpd/trunk/docs/conf/mime.types) | `'.jpg,.jpeg,.png'` |
| editable             | 是否开启编辑功能                                                                                  | boolean                            |                                                                                     | `true`              |
| proxy                | 代理                                                                                              | object                             |                                                                                     |                     |
| localProxy           | 本地代理                                                                                          | object                             |                                                                                     |                     |

### upload

imgpond 将使用该方法调用接口上传图片，返回图片链接用于回显

非必填，未配置时，value 将得到图片的 base64 编码

可选的返回值：

- `Promise 实例`: 必须 resolve 一个图片链接，或一个包含图片链接的对象（需要配置 urlAt）
- `string`: 一个图片链接，或一个包含图片链接的对象（需要配置 urlAt）
- `undefined`: 与未配置 upload 效果相同，value 将得到图片的 base64 编码

[示例代码](https://github.com/cloydlau/imgpond/blob/master/demo/index.ts)

#### 上传状态

可以通过 `this.$refs.imgpond.uploading` 获取上传状态

### valueType

默认自动：

- 数量上限为 1，且 srcAt 为空时，采用字符串类型
- 数量上限大于 1 时，采用数组类型

### srcAt

如果需要绑定值是 JSON 或 JSON 数组类型，则需要指定对象中图片 src 所在的键

初始绑定值为对象或对象数组类型时，该参数必填

upload 的返回值为对象类型时，该参数必填

### accept

图片格式校验采用原生 input 元素的 accept 属性 + 文件后缀名双重校验

### aspectRatio

- `1/1`: 限制宽高比为 1 比 1
- `['1/1']`: 限制宽高比下限不低于 1 比 1
- `['1/1', '2/1']`: 限制宽高比下限不低于 1 比 1，且上限不超过 2 比 1

### count

- `10`: 限制数量上限不超过 10 张
- `[1]`: 限制数量下限不低于 1 张
- `[1, 10]`: 限制数量下限不低于 1 张，且上限不超过 10 张

### size

- `10`: 限制体积上限不超过 10 MB
- `[1]`: 限制体积下限不低于 1 MB
- `[1, 10]`: 限制体积下限不低于 1 MB，且上限不超过 10 MB

### proxy & localProxy

如果存在跨域问题：

1. 配置 imgpond，将跨域请求转为同域请求，并附上路径标识

- 一种场景是项目本地调试时，由于 localhost 和图片链接域名不同导致跨域，需要配置代理，但上线后不再需要，此时使用 localProxy

  > 仅 localhost / 127.0.0.1 生效

- 另一种场景是图片链接域名属于第三方，无论是本地还是线上环境，都需要代理，此时使用 proxy

```ts
Vue.use(Imgpond, {
  proxy: {
    '/amap-img': 'store.is.autonavi.com'
  }
})
```

2. 配置代理，将标识过的请求转发到真实的地址

```ts
// vue.config.js

module.exports = {
  devServer: {
    proxy: {
      '/amap-img': {
        target: `http://store.is.autonavi.com`,
        pathRewrite: {
          ['^/amap-img']: ''
        }
      }
    },
  },
}
```

<br>

## 事件

| 名称         | 说明                   | 参数                 |
| ------------ | ---------------------- | -------------------- |
| size-error   | 选择的图片体积不正确时 | 图片体积（单位字节） |
| ...el-upload |

```html
<!-- 注: 原生 el-upload 的事件并不是真正的事件，而是 Function 属性，imgpond 以真正事件的形式暴露，并去掉了 on 前缀 -->

<Imgpond @remove="onRemove" @beforeUpload="onBeforeUpload"/>
```

<br>

## 嵌套在表格中

以宽高 `50px` 为例，修改为如下样式：

```scss
:deep(.pic-viewer li) {
  margin: 0 !important; // 如果允许多张，则去掉这行

  img {
    height: 50px !important;
  }
}

:deep(.el-upload-list__item) {
  width: 50px;
  height: 50px;
  margin: 0; // 如果允许多张，则去掉这行

  &>.el-upload-list__item-status-label {
    width: 34px;
    height: 18px;

    &>i {
      margin-top: 0;
    }
  }

  .el-upload-list__item-actions {
    line-height: 50px;
    font-size: 16px;

    &>span+span {
      margin-left: 4px;
    }
  }
}

:deep(.el-upload) {
  width: 50px;
  height: 50px;
  line-height: 50px;
  margin: 0;

  &>.el-icon-plus {
    font-size: initial;
  }

  &>.el-upload__text {
    display: none;
  }
}
```

<br>

## 更新日志

各版本详细改动请参考 [release notes](https://github.com/cloydlau/admate/releases) 。

<br>

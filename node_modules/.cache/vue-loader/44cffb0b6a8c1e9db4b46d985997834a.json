{"remainingRequest":"D:\\开源项目\\商城低代码\\mall-cook\\packages\\mall-cook-platform\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\开源项目\\商城低代码\\mall-cook\\packages\\mall-cook-platform\\src\\components\\SaveDialog\\HomeCover.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\开源项目\\商城低代码\\mall-cook\\packages\\mall-cook-platform\\src\\components\\SaveDialog\\HomeCover.vue","mtime":1693619752156},{"path":"D:\\开源项目\\商城低代码\\mall-cook\\packages\\mall-cook-platform\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1693619820390},{"path":"D:\\开源项目\\商城低代码\\mall-cook\\packages\\mall-cook-platform\\node_modules\\babel-loader\\lib\\index.js","mtime":1693619820336},{"path":"D:\\开源项目\\商城低代码\\mall-cook\\packages\\mall-cook-platform\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1693619820390},{"path":"D:\\开源项目\\商城低代码\\mall-cook\\packages\\mall-cook-platform\\node_modules\\vue-loader\\lib\\index.js","mtime":1693619864566}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KDQppbXBvcnQgUmVhbFRpbWVWaWV3IGZyb20gIkAvY29tcG9uZW50cy9Ub3BCYXIvUmVhbFRpbWVWaWV3IjsNCmltcG9ydCB7IHVwbG9hZENvdmVyIH0gZnJvbSAiQC9hcGkvcHJvamVjdCI7DQppbXBvcnQgZ2xvYmFsIGZyb20gIkAvY29uZmlnL2dsb2JhbCI7DQppbXBvcnQgeyBtYXBHZXR0ZXJzIH0gZnJvbSAidnVleCI7DQoNCmV4cG9ydCBkZWZhdWx0IHsNCiAgbmFtZTogIkhvbWVDb3ZlciIsDQoNCiAgY29tcG9uZW50czogew0KICAgIFJlYWxUaW1lVmlldywNCiAgfSwNCg0KICBtb3VudGVkKCkgew0KICAgIHRoaXMuZ2V0TWVzc2FnZSgpOw0KICB9LA0KDQogIGRhdGEoKSB7DQogICAgcmV0dXJuIHsNCiAgICAgIHNob3c6IGZhbHNlLA0KICAgIH07DQogIH0sDQoNCiAgY29tcHV0ZWQ6IHsNCiAgICAuLi5tYXBHZXR0ZXJzKFsicHJvamVjdCJdKSwNCg0KICAgIGlmcmFtZVVybCgpIHsNCiAgICAgIHJldHVybiBgJHtnbG9iYWwudmlld1VybH1wYWdlcy9idWlsZC9idWlsZD9vcGVyYXRlPWJ1aWxkYDsNCiAgICB9LA0KDQogICAgLy8g6aaW6aG16YWN572u5pWw5o2uDQogICAgaG9tZSgpIHsNCiAgICAgIHJldHVybiB0aGlzLnByb2plY3QucGFnZXMuZmluZCgocGFnZSkgPT4gcGFnZS5ob21lKTsNCiAgICB9LA0KICB9LA0KDQogIG1ldGhvZHM6IHsNCiAgICAvKioNCiAgICAgKiDliJ3lp4vljJYNCiAgICAgKiAxLiDliJ3lp4vljJZpZnJhbWXpobXpnaINCiAgICAgKiAyLiDnrYnlvoUyc++8jOmAmuefpWlmcmFtZeiwg+eUqOaWueazleeUn+aIkOWwgemdomJhc2U2NA0KICAgICAqDQogICAgICovDQogICAgYXN5bmMgaW5pdCgpIHsNCiAgICAgIGF3YWl0IHRoaXMub3BlbigpOw0KDQogICAgICB0aGlzLmNyZWF0ZUNvdmVyKCk7DQogICAgfSwNCg0KICAgIC8vIOaJk+W8gOW8ueeql++8jOW5tuW7tui/nzJz6L+b6KGM5ZCO57ut5pON5L2c77yIMnPnlKjkuo7muLLmn5PvvIx1bmktYXBw5Zu+54mH5riy5p+T6L6D5oWi77yJDQogICAgb3BlbigpIHsNCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7DQogICAgICAgIHRoaXMuc2hvdyA9IHRydWU7DQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgICAgIHJlc29sdmUoKTsNCiAgICAgICAgfSwgMTAwMCk7DQogICAgICB9KTsNCiAgICB9LA0KDQogICAgLy8g5Y+R6YCB54mp5paZ5YiX6KGo55So5LqO5riy5p+TDQogICAgc2V0V2lkZ2V0c01lc3NhZ2UoKSB7DQogICAgICB0aGlzLiRyZWZzLmlmcmFtZS5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKA0KICAgICAgICB7DQogICAgICAgICAgZXZlbjogImxpc3QiLA0KICAgICAgICAgIHBhcmFtczogdGhpcy5ob21lLmNvbXBvbmVudExpc3QsDQogICAgICAgIH0sDQogICAgICAgICIqIg0KICAgICAgKTsNCiAgICB9LA0KDQogICAgLy8g5Y+R6YCB5L+h5oGv77yM6YCa55+laWZyYW1l6LCD55So5pa55rOV55Sf5oiQ5bCB6Z2iYmFzZTY0DQogICAgY3JlYXRlQ292ZXIoKSB7DQogICAgICB0aGlzLiRyZWZzLmlmcmFtZS5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKA0KICAgICAgICB7DQogICAgICAgICAgZXZlbjogImNvdmVyIiwNCiAgICAgICAgfSwNCiAgICAgICAgIioiDQogICAgICApOw0KICAgIH0sDQoNCiAgICAvLyDnm5HlkKxpZnJhbWXvvIznlJ/miJDlsIHpnaJiYXNlNjTlkI7kvJrpgJrnn6Xlm57osIMNCiAgICBnZXRNZXNzYWdlKCkgew0KICAgICAgbGV0IHNlbGYgPSB0aGlzOw0KICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBmdW5jdGlvbiAoZSkgew0KICAgICAgICBsZXQgeyB0eXBlLCBwYXJhbXMgfSA9IGUuZGF0YTsNCiAgICAgICAgaWYgKHR5cGUgPT0gImdldENvdmVyQmFzZTY0Iikgew0KICAgICAgICAgIHNlbGYudXBsb2FkKHBhcmFtcy5iYXNlNjQpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9LA0KDQogICAgLy8g5LiK5Lyg5bCB6Z2iDQogICAgdXBsb2FkKGJhc2U2NCkgew0KICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsNCiAgICAgICAgbGV0IGNvdmVyRmlsZSA9IHRoaXMuZ2V0RmlsZShiYXNlNjQpOw0KICAgICAgICBsZXQgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTsNCiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCJkb21haW5JZCIsIDMpOw0KICAgICAgICBmb3JtRGF0YS5hcHBlbmQoImRpciIsICJpbWciKTsNCiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCJmaWxlIiwgY292ZXJGaWxlKTsNCiAgICAgICAgLy8g5Zu+54mH5LiK5Lyg5pyN5Yqh5ZmoDQogICAgICAgIHVwbG9hZENvdmVyKGZvcm1EYXRhKQ0KICAgICAgICAgIC50aGVuKChyZXMpID0+IHsNCiAgICAgICAgICAgIGlmICgocmVzLmVycm9yQ29kZSA9ICIwMDAwMCIpKSB7DQogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCLlm77niYfkuIrkvKDmnI3liqHlmajmiJDlip8iKTsNCiAgICAgICAgICAgICAgdGhpcy4kZW1pdCgiY29tcGxldGUiLCB7DQogICAgICAgICAgICAgICAgc3RhdHVzOiAxLA0KICAgICAgICAgICAgICAgIGRhdGE6IHJlcy5kYXRhLA0KICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9KQ0KICAgICAgICAgIC5maW5hbGx5KCgpID0+ICh0aGlzLnNob3cgPSBmYWxzZSkpOw0KICAgICAgfSk7DQogICAgfSwNCg0KICAgIC8vIGJhc2U2NOaVtOWQiOaWh+S7tg0KICAgIGdldEZpbGUoZGF0YXVybCwgZmlsZW5hbWUgPSAiZmlsZSIpIHsNCiAgICAgIGxldCBhcnIgPSBkYXRhdXJsLnNwbGl0KCIsIik7DQogICAgICBsZXQgbWltZSA9IGFyclswXS5tYXRjaCgvOiguKj8pOy8pWzFdOw0KICAgICAgbGV0IHN1ZmZpeCA9IG1pbWUuc3BsaXQoIi8iKVsxXTsNCiAgICAgIGxldCBic3RyID0gYXRvYihhcnJbMV0pOw0KICAgICAgbGV0IG4gPSBic3RyLmxlbmd0aDsNCiAgICAgIGxldCB1OGFyciA9IG5ldyBVaW50OEFycmF5KG4pOw0KICAgICAgd2hpbGUgKG4tLSkgew0KICAgICAgICB1OGFycltuXSA9IGJzdHIuY2hhckNvZGVBdChuKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBuZXcgRmlsZShbdThhcnJdLCBgJHtmaWxlbmFtZX0uJHtzdWZmaXh9YCwgew0KICAgICAgICB0eXBlOiBtaW1lLA0KICAgICAgfSk7DQogICAgfSwNCiAgfSwNCn07DQo="},{"version":3,"sources":["HomeCover.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgCA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"HomeCover.vue","sourceRoot":"src/components/SaveDialog","sourcesContent":["<!--\r\n * @Description: 首页封面\r\n * @Autor: WangYuan\r\n * @Date: 2021-09-27 17:45:38\r\n * @LastEditors: WangYuan\r\n * @LastEditTime: 2022-02-11 10:26:53\r\n-->\r\n<template>\r\n  <el-dialog\r\n    :visible.sync=\"show\"\r\n    :append-to-body=\"true\"\r\n    :show-close=\"false\"\r\n    :close-on-click-modal=\"false\"\r\n    top=\"50px\"\r\n    width=\"415px\"\r\n    class=\"flex-center\"\r\n  >\r\n    <div v-loading=\"show\" id=\"cover\" class=\"cover\">\r\n      <iframe\r\n        v-if=\"show\"\r\n        ref=\"iframe\"\r\n        class=\"w-100\"\r\n        frameborder=\"no\"\r\n        :style=\"{ height: '667px' }\"\r\n        :src=\"iframeUrl\"\r\n        @load=\"setWidgetsMessage\"\r\n      ></iframe>\r\n    </div>\r\n  </el-dialog>\r\n</template>\r\n\r\n<script>\r\nimport RealTimeView from \"@/components/TopBar/RealTimeView\";\r\nimport { uploadCover } from \"@/api/project\";\r\nimport global from \"@/config/global\";\r\nimport { mapGetters } from \"vuex\";\r\n\r\nexport default {\r\n  name: \"HomeCover\",\r\n\r\n  components: {\r\n    RealTimeView,\r\n  },\r\n\r\n  mounted() {\r\n    this.getMessage();\r\n  },\r\n\r\n  data() {\r\n    return {\r\n      show: false,\r\n    };\r\n  },\r\n\r\n  computed: {\r\n    ...mapGetters([\"project\"]),\r\n\r\n    iframeUrl() {\r\n      return `${global.viewUrl}pages/build/build?operate=build`;\r\n    },\r\n\r\n    // 首页配置数据\r\n    home() {\r\n      return this.project.pages.find((page) => page.home);\r\n    },\r\n  },\r\n\r\n  methods: {\r\n    /**\r\n     * 初始化\r\n     * 1. 初始化iframe页面\r\n     * 2. 等待2s，通知iframe调用方法生成封面base64\r\n     *\r\n     */\r\n    async init() {\r\n      await this.open();\r\n\r\n      this.createCover();\r\n    },\r\n\r\n    // 打开弹窗，并延迟2s进行后续操作（2s用于渲染，uni-app图片渲染较慢）\r\n    open() {\r\n      return new Promise((resolve, reject) => {\r\n        this.show = true;\r\n        setTimeout(() => {\r\n          resolve();\r\n        }, 1000);\r\n      });\r\n    },\r\n\r\n    // 发送物料列表用于渲染\r\n    setWidgetsMessage() {\r\n      this.$refs.iframe.contentWindow.postMessage(\r\n        {\r\n          even: \"list\",\r\n          params: this.home.componentList,\r\n        },\r\n        \"*\"\r\n      );\r\n    },\r\n\r\n    // 发送信息，通知iframe调用方法生成封面base64\r\n    createCover() {\r\n      this.$refs.iframe.contentWindow.postMessage(\r\n        {\r\n          even: \"cover\",\r\n        },\r\n        \"*\"\r\n      );\r\n    },\r\n\r\n    // 监听iframe，生成封面base64后会通知回调\r\n    getMessage() {\r\n      let self = this;\r\n      window.addEventListener(\"message\", function (e) {\r\n        let { type, params } = e.data;\r\n        if (type == \"getCoverBase64\") {\r\n          self.upload(params.base64);\r\n        }\r\n      });\r\n    },\r\n\r\n    // 上传封面\r\n    upload(base64) {\r\n      return new Promise((resolve, reject) => {\r\n        let coverFile = this.getFile(base64);\r\n        let formData = new FormData();\r\n        formData.append(\"domainId\", 3);\r\n        formData.append(\"dir\", \"img\");\r\n        formData.append(\"file\", coverFile);\r\n        // 图片上传服务器\r\n        uploadCover(formData)\r\n          .then((res) => {\r\n            if ((res.errorCode = \"00000\")) {\r\n              console.log(\"图片上传服务器成功\");\r\n              this.$emit(\"complete\", {\r\n                status: 1,\r\n                data: res.data,\r\n              });\r\n            }\r\n          })\r\n          .finally(() => (this.show = false));\r\n      });\r\n    },\r\n\r\n    // base64整合文件\r\n    getFile(dataurl, filename = \"file\") {\r\n      let arr = dataurl.split(\",\");\r\n      let mime = arr[0].match(/:(.*?);/)[1];\r\n      let suffix = mime.split(\"/\")[1];\r\n      let bstr = atob(arr[1]);\r\n      let n = bstr.length;\r\n      let u8arr = new Uint8Array(n);\r\n      while (n--) {\r\n        u8arr[n] = bstr.charCodeAt(n);\r\n      }\r\n      return new File([u8arr], `${filename}.${suffix}`, {\r\n        type: mime,\r\n      });\r\n    },\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.cover {\r\n  width: 375px;\r\n  min-height: 667px;\r\n  overflow: hidden;\r\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\r\n}\r\n</style>\r\n"]}]}